<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC 客户端 B</title>
</head>
<body>
    <h1>WebRTC 视频通话 - 客户端 B</h1>
    <video id="localVideo" autoplay playsinline></video>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const ws = new WebSocket('ws://localhost:8080/ws?id=peerB');  // 客户端 B 的 ID
        let peerConnection;
        let localStream;
        const remoteVideo = document.getElementById("remoteVideo");
        const localVideo = document.getElementById("localVideo");

        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]  // STUN 服务器
        };

        // 获取本地视频流
        async function getLocalStream() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            localVideo.srcObject = localStream;
        }

        // 创建 PeerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);

            // 将本地视频流的轨道添加到 PeerConnection 中
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            // 处理 ICE candidate
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    // 发送 ICE candidate 到信令服务器
                    ws.send(JSON.stringify({ target: 'peerA', type: 'candidate', candidate: event.candidate }));
                }
            };

            // 处理远程视频流
            peerConnection.ontrack = event => {
                remoteVideo.srcObject = event.streams[0];
            };
        }

        // 处理 WebSocket 消息
        ws.onmessage = async (message) => {
            const data = JSON.parse(message.data);

            if (data.type === 'offer') {
                // 收到来自客户端 A 的 offer，设置远程描述并创建 answer
                await handleOffer(data);
            } else if (data.type === 'answer') {
                // 收到来自客户端 A 的 answer，设置远程描述
                await handleAnswer(data);
            } else if (data.type === 'candidate') {
                // 处理 ICE candidate
                await handleCandidate(data.candidate);
            }
        };

        // 处理来自客户端 A 的 offer
        async function handleOffer(offer) {
            // 创建 PeerConnection
            await createPeerConnection();

            // 设置远程描述
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));

            // 创建 answer
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // 发送 answer 到客户端 A
            ws.send(JSON.stringify({ target: 'peerA', type: 'answer', sdp: answer.sdp }));
        }

        // 处理来自客户端 A 的 answer
        async function handleAnswer(answer) {
            // 设置远程描述
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // 处理 ICE candidate
        async function handleCandidate(candidate) {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
                console.error('Error adding ICE candidate:', e);
            }
        }

        // 初始化
        getLocalStream();

        // WebSocket 连接成功
        ws.onopen = () => {
            console.log('WebSocket connected for Client B');
        };

        // WebSocket 连接关闭
        ws.onclose = () => {
            console.log('WebSocket connection closed');
        };
    </script>
</body>
</html>
